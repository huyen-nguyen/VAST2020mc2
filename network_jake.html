<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<style>
    button {
        position: absolute;
    }

    .node {
        stroke: white;
        stroke-width: 1px;
    }

    #filter {
        top: 25em;
        left: 1em;
    }

    input {border: 1px dotted #ccc; background: white; font-family: monospace; padding: 10px 20px; font-size: 18px; margin: 20px 10px 20px 0;}
    input:focus { background-color:#ddd; outline: none;}

    .menu{
        position: absolute;
        left: 570px;
        top: 89px;
    }

    .selectButton {
        position: absolute;
        left: 720px;
        top: 88px;
    }

    .referenceImg{
        position: absolute;
        left: 840px;
        top: 20px;
    }

</style>
<button type="button" class="filter-btn" id="filter">Filter Links</button>
<head>
    <select id="select1" class="menu" style = "font-family:monospace; font-size:14px">
        <option value="birdCall">birdCall</option>
        <option value="blueSunglasses">blueSunglasses</option>
        <option value="brownDie">brownDie</option>
        <option value="cactusPaper">cactusPaper</option>
        <option value="canadaPencil">canadaPencil</option>
        <option value="carabiner">carabiner</option>
        <option value="cloudSign">cloudSign</option>
        <option value="cowbell">cowbell</option>
        <option value="cupcakePaper">cupcakePaper</option>
        <option value="eyeball">eyeball</option>
        <option value="foamDart">foamDart</option>
        <option value="gClamp">gClamp</option>
        <option value="giftBag">giftBag</option>
        <option value="glassBead">glassBead</option>
        <option value="gyroscope">gyroscope</option>
        <option value="hairClip">hairClip</option>
        <option value="hairRoller">hairRoller</option>
        <option value="lavenderDie">lavenderDie</option>
        <option value="legoBracelet">legoBracelet</option>
        <option value="metalKey">metalKey</option>
        <option value="miniCards">miniCards</option>
        <option value="noisemaker">noisemaker</option>
        <option value="paperPlate">paperPlate</option>
        <option value="partyFavor">partyFavor</option>
        <option value="pinkCandle">pinkCandle</option>
        <option value="pinkEraser">pinkEraser</option>
        <option value="plaidPencil">plaidPencil</option>
        <option value="pumpkinNotes">pumpkinNotes</option>
        <option value="rainbowPens">rainbowPens</option>
        <option value="redBow">redBow</option>
        <option value="redDart">redDart</option>
        <option value="redWhistle">redWhistle</option>
        <option value="rubiksCube">rubiksCube</option>
        <option value="sign">sign</option>
        <option value="silverStraw">silverStraw</option>
        <option value="spiderRing">spiderRing</option>
        <option value="stickerBox">stickerBox</option>
        <option value="trophy">trophy</option>
        <option value="turtle">turtle</option>
        <option value="vancouverCards">vancouverCards</option>
        <option value="voiceRecorder">voiceRecorder</option>
        <option value="yellowBag">yellowBag</option>
        <option value="yellowBalloon">yellowBalloon</option>
    </select>
    <button onclick="getOption()" class="selectButton" style = "font-family:monospace; font-size:14px">
        Show Object
    </button>
    <div id="theDiv" class="referenceImg"></div>
    <h1>
        Mini Challenge 2
        <div name="myform">
            <input onClick=submitted() name="Submit"  type="submit" value="Update Classificaion" >
            <input type="text" id="myVal" >
        </div>
    </h1>
    <h2>
        <script src="https://d3js.org/d3.v5.js"></script>
        <script src="https://unpkg.com/d3-simple-slider"></script>

        <p style = "font-family:georgia,garamond,serif;font-size:12px;" id="value">0</p>
        <div id="slider"></div>

        <script>
            var slider = d3
                .sliderHorizontal()
                .min(0)
                .max(1)
                .step(.025)
                .width(300)
                .value(0)
                .displayValue(false)
                .on('onchange', (val) => {
                    d3.select('#value').text(val.toFixed(3));
                });

            d3.select('#slider')
                .append('svg')
                .attr('width', 500)
                .attr('height', 100)
                .append('g')
                .attr('transform', 'translate(30,30)')
                .call(slider);


        </script>


    </h2>
    <h3>

    </h3>
</head>
<body>


<script src="https://d3js.org/d3.v4.min.js"></script>
<script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
<script>

    //	data stores
    var graph, store;

    //	svg selection and sizing
    var width = 1700,
        height = 1500

    var key1 = d3.select("svg")
        .append("g");

    key1.append("circle")
        .attr("cx", 380)
        .attr("cy", 10)
        .attr("r", 8)
        .style("fill", "#0000FF");

    key1.append("text")
        .attr("dx", 390)
        .attr("dy", 14)
        .style("font-size", "10px")
        .text("Person");

    var key2 = d3.select("svg")
        .append("g");

    key2.append("circle")
        .attr("cx", 380)
        .attr("cy", 30)
        .attr("r", 8)
        .style("fill", "#FF0000");

    key2.append("text")
        .attr("dx", 390)
        .attr("dy", 34)
        .style("font-size", "10px")
        .text("Object");

    var key3 = d3.select("svg")
        .append("g");

    key3.append("circle")
        .attr("cx", 380)
        .attr("cy", 50)
        .attr("r", 8)
        .style("fill", "#D2B48C");

    key3.append("text")
        .attr("dx", 390)
        .attr("dy", 54)
        .style("font-size", "10px")
        .text("Image");

    //	svg selection and sizing
    var svg = d3.select("svg")
        .attr("width", width)
        .attr("height", height);
    radius = 3.5;

    //	d3 color scales
    var color = d3.scaleOrdinal(d3.schemeCategory10);

    var link = svg.append("g").selectAll(".link"),
        node = svg.append("g").selectAll(".node");

    //	force simulation initialization
    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink()
            .id(function(d) { return d.id; }).distance(40))
        .force("charge", d3.forceManyBody()
            .strength(function(d) { return -2.5;}))
        .force("center", d3.forceCenter(width / 2, height / 2.5));

    //	filter button event handlers
    $(".filter-btn").on("click", function() {
        linkFilter = document.getElementById("value").innerHTML
        filter();
        update();
    });

    //	data read and store
    d3.json("graph.json", function(err, g) {
        if (err) throw err;

        var nodeByID = {};

        g.nodes.forEach(function(n) {
            nodeByID[n.id] = n;
        });

        store = g;
        graph = {};
        Object.keys(g).forEach(key=>graph[key] = store[key].map(d=>d))
        update();
    });

    //	general update pattern for updating the graph
    function update() {
        //	UPDATE
        node = node.data(graph.nodes, function(d) { return d.id;});

        //	EXIT
        node.exit().remove();
        //	ENTER
        var newNode = node.enter().append("g")
            .on("mouseover", mouseover)
            .on("mouseout", mouseout)
            .on( 'click', function (d) {
                document.getElementById('myVal').value = d.id;
            })
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended)
            );

        newNode.append("circle")
            .attr("class", "node")
            .attr("r", radius)
            .attr("fill", function(d) {return (d.group);});

        newNode.append("title")
            .text(function(d) {
                if (d.img){
                    return "group: " + d.group + "\n" + "id: " + d.id +"\n" +"img: " + d.img;
                }
                else {
                    return "group: " + d.group + "\n" + "id: " + d.id;
                }
            });

        var image_g = newNode.append('g').attr('class','image_g').attr('transform','scale(0.1)');
        image_g.each(function(){
            d3.select(this).datum()['Jake'] = d3.select(this);
        })
        image_g
            .append("image")
            .attr("xlink:href",  function(d) { return d.img;})
            .attr("x", function(d) { return -50;})
            .attr("y", function(d) { return -50;})
            .attr("height", 100)
            .attr("width", 100);

        //	ENTER + UPDATE
        node = node.merge(newNode);

        //	UPDATE
        link = link.data(graph.links1, function(d) { return d.id;});
        //	EXIT
        link.exit().remove();
        //	ENTER
        newLink = link.enter().append("line")
            .on( 'mouseover' , function (d){
                d3.select(this).attr("stroke-width", function (e) {
                    if (e.value != 0){
                        return e.value*5;
                    }
                    else return 2
                })
            })
            .on( 'mouseout' , function (d){
                d3.select(this).attr("stroke-width", function (e) {
                    if (e.value != 0){
                        return e.value*2;
                    }
                    else return 1
                })
            })
            .on( 'click', function (d) {
                document.getElementById('myVal').value = d.target.id;
                d3.select("#myVal").datum(d)
                var selectedlink = d3.select(this);
                var image_g = selectedlink.datum().source['Jake']
                    .attr('transform','scale(1)');
                var image_g2= selectedlink.datum().target['Jake']
                    .attr('transform','scale(1)');
                var imgD = new Image();
                imgD.src = d.source.img
                var originalHeight = imgD.height;
                var originalWidth = imgD.width;
                image_g
                    .append("rect")
                    .attr("x", d.x*(100/originalWidth) - 50)
                    .attr("y", d.y*(100/originalHeight) - 50)
                    .attr("width", d.width*(100/originalWidth))
                    .attr("height", d.height*(100/originalHeight))
                    .attr("stroke", "red")
                    .attr("stroke-width", 2)
                    .attr("fill", "none")
            })
            .attr("class", "link")
            .attr("stroke-width", function(d) {
                if ((d.value != 1) && (d.value != 0)){
                    return d.value*2
                }
                else if (d.value === 0){
                    return 1
                }})
            .attr("stroke", function(d) {
                if (d.value < 1 && d.value > .9) {
                    return "#000000"
                }
                else if (d.value < .9 && d.value > .8) {
                    return "#111111"
                }
                else if (d.value < .8 && d.value > .7) {
                    return "#222222"
                }
                else if (d.value < .7 && d.value > .6) {
                    return "#333333"
                }
                else if (d.value < .6 && d.value > .5) {
                    return "#444444"
                }
                else if (d.value < .5 && d.value > .4) {
                    return "#555555"
                }
                else if (d.value < .4 && d.value > .3) {
                    return "#666666"
                }
                else if (d.value < .3 && d.value > .2) {
                    return "#777777"
                }
                else if (d.value < .2 && d.value > .1) {
                    return "#888888"
                }
                else { return "#999999"}

            });

        newLink.append("title")
            .text(function(d) { return "source: " + d.source + "\n" + "target: " + d.target + "\n" + "value: " + d.value; });
        //	ENTER + UPDATE
        link = link.merge(newLink);

        //	update simulation nodes, links, and alpha
        simulation
            .nodes(graph.nodes)
            .on("tick", ticked);

        simulation.force("link")
            .links(graph.links1);

        simulation.alpha(1).alphaTarget(0).restart();
    }

    function submitted() {
        var link = d3.select("#myVal").datum();
        link.souce = link.source.id;
        var new_target = d3.select("#myVal").node().value;
        if (graph.nodes.find(d=>d.id===new_target)){
            link.target = new_target;
            link.value = 1;
            if (new_target == "none") {
                link.value = 0;
            }
            update();
        }else{
            alert('Item does not exist in our data!')
            // may be add new node?
        }
    }

    //	drag event handlers
    function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    //	tick event handler without a bounded box
    function ticked() {
        node
            .attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; })
            .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });


        link
            .attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });
    }

    function mouseover() {
        var image_g = d3.select(this).select('g.image_g')
            .attr('transform','scale(1)');
    }

    function mouseout() {
        d3.select(this).select('g.image_g')
            .attr('transform','scale(0.1)')
        d3.selectAll('g.image_g rect').remove()
    }

    function filter() {
        graph.links1 =  store.links1.filter(function(l) {
            if ((linkFilter <= l.value)) {
                l.filtered = false;
                return true;
            }else if ((linkFilter > l.value)) {
                l.filtered = true;
                return false;
            }
        });
        update();
    }
    function getOption() {
        //document.getElementById('theDiv').remove()
        selectElement =
            document.querySelector('#select1');

        output = "MC2-Image-Data/TrainingImages/" + selectElement.value + "/" + selectElement.value + "_2.jpg";


        var dv = document.getElementById('theDiv');
        while (dv.hasChildNodes()) {
            dv.removeChild(dv.lastChild);
        }

        var img = document.createElement("IMG");
        img.src = output;
        img.height = 140
        img.width = 220
        document.getElementById('theDiv').append(img);


    }



</script>
</body>